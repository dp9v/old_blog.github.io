---
layout: post
title:  "Хранениние java объектов"
date:   2017-04-03 21:02:00 +0800
categories: Java
tags: [java, Object, storage, хранение ]
author: Polkovnikov Dmitriy
description: "Виды памяти в Java и хранение java объектов"
---

Для хранения данных в процессе исполнения используются оперативная память,
и во разных языках программирования работа с памятью реализована по разному.
В данном посте я опишу некоторые подробности о работе с памятью и хранении объектов в Java.

#### Виды памяти в Java:

1. `Stack` - эта область памяти используется для хранения примитивных типов данных, ссылок на другие объкты в памяти, а так же вспомогательной информации при вызове методов.

2. `Permanent Generation` - Область памяти в которой хранятся данные классов, значения статических переменных и пулы констант.
    Начиная с 8й версии PermGen заменен на `Meta Space`.

3. `Heap`(куча) - Основная область памяти в которой хранятся все объекты, используемые в приложении.
В данной области работает сборщик мусора и он следит, за правильным заполнением памяти. Сама куча так же разбита на несколько чатей.
Это сделано для оптимизации работы GC. Подробнее эту тему я рассмотрю позже.

#### Хранение описания классов

Как было сказано выше в `PermGen`e хранятся данные классов. Это сделано за счет специального класса `Class`.
Этот класс хранит в себе рефлексивные данные класса. Он хранит типы классов(объект, интерфейс, массив),
имя класса, конструкторы, поля, методы и вложенные классы.

#### Хранение объектов

Помимо объектов, явно описанных в описании класса, в объектах хранится и другая вспомогательная информация.
Далее представленна общая структура объекта в памяти:

1. Заголовок объекта.
2. Примитивнае типы, обявленные при описании.
3. Ссылочные типы, объявленные при описании.
4. Смещение.

Если со 2 и 3 все понятно, то на смещении и заголовке остановлюсь подробнее.

Смещение представляет собой несколько неиспользуемых байт, которые размещаются после самого объекта.
Это сделано для того, чтоб адрес следующего объекта в памяти был кратен размеру машинного слова
(помогает оптимизировать работу с памятью). В java размер объекта кратен 8 байтам.

#### Заголовок объекта

Заголовок объекта состоит из 2х машинных слов (8 байт для x32, и 16 для x64).
Заголовок объекта может хранит в себе некоторую необходимую для работы приложения информацию:

1. Маркировочное слово (Mark Word) - размер равен одному машинному слову. Содержит в себе hashCode, Garbage Collection Information и Lock:

    1. `hashCode` - Хранит в себе хэш-код объекта.
    Если в описании класса не переопределен метод `hashCode()`, то хэш вычисляется из адреса в памяти.
    Но при работе GC объект может быть перенесен в другой участок памяти.
    Именно для этого сгенерированый хэш хранится в заголовке объекта.
    2. `Garbage Collection Information` - Информация для сборщика мусора.
    Может содержать как бит-флаг, так и комбинацию бит, хранящую количество ссылок на объект.
    3. `Lock` - информация о состоянии блокировки при многопоточности.

2. Type Information Block Pointer - хранит информацию о типе объекта: таблицу виртуальных методов, ссылку на объект класса, ссылку на никоторые дополнительные структуры.

3. Length - опционально. Доболнительные 4 байта, хранящие длинну массива, если объект массив.


Ссылки:

1. [PDF-презентация "Боремся за память в java"](http://jug.ua/wp-content/uploads/2013/02/Java.pdf)